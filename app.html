<script>
if (!sessionStorage.getItem("cpcc_session")) {
  location.replace("index.html");
}
</script>


<!DOCTYPE html>
<html>
<head>
<title>LJC CPCC System v4.1.2</title>

<!-- Inter Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body {
  margin:0;
  font-family:'Inter', Arial, sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#eee;
}

input, select, button {
  font-family:'Inter', Arial, sans-serif;
  font-weight:500;
  padding:8px;
  font-size:14px;
}


header {
  position:fixed;
  top:0; left:0; right:0;
  height:70px;
  background:#0b5f3c;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:22px;
  font-weight:600;
  z-index:1000;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
}

header img { height:67px; }

#topBar {
  position:fixed;
  top:70px; left:0; right:0;
  display:flex;
  gap:10px;
  padding:10px;
  background:#ddd;
  z-index:900;
  box-shadow:0 2px 4px rgba(0,0,0,0.15);
}


#main { flex:1; display:flex; margin-top:130px; }

#left {
  width:40%;
  background:#111;
  color:white;
  padding:10px;
  display:flex;
  flex-direction:column;
}

#outletBox{
  padding:8px 14px;
  background:#0b5f3c;
  color:white;
  font-weight:700;
  border-radius:6px;
  min-width:160px;
  text-align:center;
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.2);
}


#orderList { flex:1; overflow-y:auto; }

.order-item {
  display:flex;
  align-items:center;
  padding:6px;
  border-bottom:1px solid #333;
}

.item-name { flex:1; }

.qty-controls {
  display:flex;
  align-items:center;
  gap:4px;
  min-width:90px;
  justify-content:center;
  margin-right:8px;
}

.qty-number { width:24px; text-align:center; }

.qty-btn { padding:3px 8px; }
.del-btn { background:red; color:white; border:none; padding:3px 6px; }

#total { padding:10px; border-top:2px solid #555; }

#actions button {
  padding:12px;
  font-size:16px;
  margin-top:5px;
}

#right {
  width:60%;
  display:flex;
  flex-direction:column;
}



#categories {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 6px;
  background: #333;
  padding: 6px;
}


.cat-btn {
  padding: 4px;
  background: #555;
  color: white;
  border: none;
  border-radius: 6px;
  text-align: center;
  white-space: normal;
  font-size:12px;
}

#backBtn {
  display: none;          /* hidden initially */
  padding:10px 15px;
  font-size:16px;
  background:#0b5f3c;
  color:white;
  border:none;
  border-radius:6px;
  margin-bottom:10px;
  cursor:pointer;
}



#menuGrid {
  flex:1;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  padding:10px;
}

.menu-btn {
  padding: 12px;        /* smaller padding to fit more text */
  font-size: 14px;      /* reduce font size */
  border: none;
  border-radius: 6px;   /* slightly smaller radius */
  text-align: center;
  white-space: normal;  /* allow text to wrap into multiple lines */
  word-wrap: break-word;
}


.pad{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#222;
  color:white;
  padding:10px;
  border-radius:10px;
  display:none;
  z-index:5000;
  box-shadow:0 0 20px rgba(0,0,0,.6);
}

.pad-header{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}

.pad-grid{
  display:grid;
  grid-template-columns:repeat(3,60px);
  gap:8px;
}

.pad button{
  padding:14px;
  font-size:18px;
  border:none;
  background:#555;
  color:white;
  border-radius:6px;
}


.kbd-grid{
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:6px;
}

.kbd-grid button{
  padding:14px;
  font-size:18px;
  background:#444;
  color:white;
  border:none;
  border-radius:6px;
}

#historyPane th,
#historyPane td {
  border-bottom: 1px solid #ddd;
  text-align: left;
  font-size: 14px;
}





#right {
  overflow: hidden;
  display: flex;
  flex-direction: column;
}


#historyContainer {
  display:none;
  width:100%;
  padding:10px;
  box-sizing:border-box;
}

body.history-open #historyContainer {
  display:block;
}

body.history-open #topBar {
  display:none;
}

body.history-open #main {
  display:none;
}

#historyPane {
  display:flex !important;
  height: calc(100vh - 90px);
}

/* Force History to be full-page vertical layout */
#historyContainer {
    width: 100%;
    display: none;
}

body.history-open #historyContainer {
    display: block;
}

/* Reset any inherited POS flex layout */
#historyPane {
    display: flex !important;
    flex-direction: column !important;
    width: 100% !important;
    height: calc(100vh - 90px);
    background: #f5f5f5;
    box-sizing: border-box;
}

/* Prevent filters from becoming a sidebar */
#historyPane > div {
    width: 100% !important;
}


body.history-open #historyContainer {
    display: block;
    margin-top: 70px;   /* push below fixed header */
}

#historyPane {
    height: calc(100vh - 70px) !important;
}


.history-table {
  table-layout: fixed;
  width: 100%;
}

.history-table th,
.history-table td {
  padding: 8px 10px;
  text-align: left;
  box-sizing: border-box;
}

.history-table col.date      { width: 90px; }
.history-table col.cpccref   { width: 110px; }
.history-table col.customer { width: 220px; }
.history-table col.total    { width: 110px; }
.history-table col.cpcc     { width: 90px; }
.history-table col.cash     { width: 90px; }
.history-table col.receipt  { width: 140px; }
.history-table col.remarks { width: 220px; }





</style>
</head>

<body>


<div id="pinModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#111a;display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:white;padding:20px;border-radius:8px;text-align:center;">
    <h2>Enter PIN</h2>
    <input type="password" id="pinInput">
    <button id="pinSubmit">Submit</button>
  </div>
</div>

<div id="lockTimer" style="
    display:none;
    position:fixed;
    top:20px;
    right:20px;
    padding:12px 20px;
    background:#ff5555;
    color:white;
    font-size:18px;
    border-radius:6px;
    z-index:9999;
">
  Locked for <span id="lockMinutes">10</span>:<span id="lockSeconds">00</span>
</div>


<header>
  <img src="https://ljcrestaurant.com/wp-content/uploads/2023/08/LJC_-Logo-in-Green-Box.jpg">
  <span>LJC CPCC System</span>
</header>

<div id="historyContainer">
  <div id="historyPane">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>CPCC Transaction History</h3>
      <button onclick="closeHistory()" style="font-size:18px;">‚úï</button>
    </div>

    <!-- Filters -->
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input type="text" value="FJ MOA" disabled style="width:140px;">
      <input type="date" id="historyFrom">
      <input type="date" id="historyTo">
      <button onclick="fetchHistory()">Fetch</button>
    </div>

    <!-- Results -->
    <div style="flex:1; display:flex; flex-direction:column; border:1px solid #ccc; background:white;">
      <table class="history-table" style="border-collapse:collapse;">
        <colgroup>
          <col class="date">
          <col class="cpccref">
          <col class="customer">
          <col class="total">
          <col class="cpcc">
          <col class="cash">
          <col class="receipt">
          <col class="remarks">
        </colgroup>
        <thead style="background:#ddd;">
          <tr>
            <th>Date</th>
            <th>CPCC Ref #</th>
            <th>Customer</th>
            <th>Line Total</th>
            <th>CPCC</th>
            <th>Cash</th>
            <th>Receipt #</th>
            <th>Remarks</th>
          </tr>
        </thead>
      </table>

      <div style="flex:1; overflow-y:auto;">
        <table class="history-table" style="border-collapse:collapse;">
          <colgroup>
            <col class="date">
            <col class="cpccref">
            <col class="customer">
            <col class="total">
            <col class="cpcc">
            <col class="cash">
            <col class="receipt">
            <col class="remarks">
          </colgroup>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>


<div id="topBar" class="cpcc-tabs">
  <div id="outletBox">FJ MOA</div>


<select id="customerSelect" onchange="handleCustomer()">
  <option value="">Loading CPCC users‚Ä¶</option>
</select>


  <input id="customerOther" placeholder="Enter Customer Name" style="display:none">
  <input id="cpcc" placeholder="CPCC Ref #" inputmode="numeric">
  <input id="date" type="date">
  <input id="remarks" placeholder="Remarks">
</div>

<div id="main">
  <div id="left">
    <h3>ORDER</h3>
    <div id="orderList"></div>
    <div id="total"></div>

    <div id="excessReceipt" style="display:none; margin-top:10px; padding:10px; background:#fff4e5; border:1px solid #ffa500; border-radius:6px;">
      <label for="receiptNumber" style="color:red;"><b>Excess Payment Receipt #:</b></label><br>
      <input type="text" id="receiptNumber" placeholder="Enter receipt number" style="padding:6px; width:100%; margin-top:4px;">
      <small style="color:#555;">Required if transaction exceeds CPCC limit</small>
    </div>



    <div id="actions">
      <button onclick="confirmOrder()">Confirm</button>
      <button onclick="cancelOrder()">Cancel</button>
      <button onclick="openHistory()">History</button>
    </div>
  </div>

  <div id="right">
    <div id="categories"></div>
    <button id="backBtn" onclick="showCategories()">‚Üê Back</button>
    <div id="menuGrid"></div>
  </div>
</div>



<script>
/* ===== SECURITY FLOW (OBFUSCATED ‚Äì PHASE 1) ===== */

(function () {

  const _k = "CPCC_LJC_2026_PRIVATE_KEY";

  const _t = "FJ_MOA_POS01";
  const _o = "FJ MOA";
  window.OUTLET_NAME    = "FJ MOA";  // Friendly name for Google Sheet
  window.FIXED_OUTLET   = window.OUTLET_NAME; // legacy reference
  window.HISTORY_OUTLET = window.OUTLET_NAME;
  window.HISTORY_URL    = "https://script.google.com/macros/s/AKfycbzqT5VRNzKoSH76gbQUOyRuqBPpHBEYLlAtkJPF6lgmLLpAy3ELxADSUT067reuMje66A/exec";

  const _u =
    "https://script.google.com/macros/s/AKfycbxlZn5aPGcx5lIgg1-jnTCJgHUZrrynIw5fRMgPeRasZRn-rZeq5ZaLz47V54a8H4Fapg/exec";

  const _s = function (m) {
    document.body.innerHTML =
      '<div style="display:flex;align-items:center;justify-content:center;' +
      'height:100vh;background:#111;color:white;' +
      'font-size:28px;text-align:center;">' +
      m +
      "</div>";
  };

  window._cb = function (p) {
    try {
      if (!p.ok) throw 0;

      const d = new Date();
      const r = p.terminals.find(e =>
        e.outlet === _o &&
        e.terminal === _t &&
        e.active === "Y" &&
        (!e.expiry || new Date(e.expiry) >= d)
      );

      if (!r) {
        _s("TERMINAL DISABLED<br><br>Contact Head Office");
        return;
      }

      console.log("‚úÖ Terminal validated");
      document.getElementById("pinModal").style.display = "flex";

    } catch {
      _s("LICENSE SERVER UNREACHABLE");
    }
  };

  
  window.TERMINAL_URL = _u;
  window.API_KEY = _k;
  window.TERMINAL_ID = _t;

})();

</script>


<script>
(function () {

  window._sa = function () {
    if (typeof window.fetchCPCCUsers === "function") {
      window.fetchCPCCUsers();
    } else {
      console.error("fetchCPCCUsers not found");
    }

    if (typeof window.fetchMenu === "function") {
      window.fetchMenu();
    } else {
      console.error("fetchMenu not found");
    }
  };

  window._pcb = function (r) {
    if (!r.ok) {
      alert("PIN server unreachable");
      return;
    }

    if (r.valid) {
      const m = document.getElementById("pinModal");
      if (m) m.style.display = "none";

      const l = document.getElementById("lockTimer");
      if (l) l.style.display = "none";

      window._sa();
      return;
    }

    if (r.error === "LOCKED") {
      alert(`Too many attempts. Try again in ${r.retryAfterMinutes} minutes.`);
      if (r.retryAfterMinutes) {
        _lc(r.retryAfterMinutes * 60);
      }
      return;
    }

    if (r.error === "TOO_MANY_ATTEMPTS") {
      alert(`Too many attempts. Locked for ${r.lockedMinutes} minutes.`);
      return;
    }

    alert("Incorrect PIN");
  };

  let _li;

  function _lc(t) {
    const d = document.getElementById("lockTimer");
    const m = document.getElementById("lockMinutes");
    const s = document.getElementById("lockSeconds");

    if (_li) clearInterval(_li);
    d.style.display = "block";

    let r = t;

    _li = setInterval(() => {
      const mm = Math.floor(r / 60);
      const ss = r % 60;

      m.textContent = String(mm).padStart(2, "0");
      s.textContent = String(ss).padStart(2, "0");

      r--;

      if (r < 0) {
        clearInterval(_li);
        d.style.display = "none";
      }
    }, 1000);
  }

  function _vp() {
    const p = document.getElementById("pinInput").value;
    if (!p) {
      alert("Enter PIN");
      return;
    }

    const x = document.createElement("script");
    x.src =
      TERMINAL_URL +
      "?apiKey=" + encodeURIComponent(API_KEY) +
      "&action=validatePin" +
      "&pin=" + encodeURIComponent(p) +
      "&terminal=" + encodeURIComponent(TERMINAL_ID) +
      "&callback=_pcb";

    x.onerror = () => alert("PIN server unreachable");
    document.head.appendChild(x);
  }

  document
    .getElementById("pinSubmit")
    .addEventListener("click", _vp);

})();
</script>

<script>
// ==========================
// SESSION-PROTECTED CALLS
// ==========================

function validateTerminal() {
  const s = document.createElement("script");
  s.src =
    TERMINAL_URL +
    "?apiKey=" + encodeURIComponent(API_KEY) +
    "&action=checkTerminal" +
    "&terminal=" + encodeURIComponent(TERMINAL_ID) +
    "&sessionToken=" + encodeURIComponent(window.SESSION_TOKEN) +
    "&callback=_cb";

  s.onerror = () => _s("LICENSE SERVER UNREACHABLE");
  document.head.appendChild(s);
}

</script>

<script>
(function () {

  /* ===== DATA ===== */
  let _cl = {};
  let _c = {};
  window._u = null;
  window._f = false;

  /* ===== HELPERS ===== */
  function _mk(d){
    const x = new Date(d);
    return x.getFullYear() + "-" + (x.getMonth() + 1);
  }

  function _cn(){
    return customerSelect.value === "Others"
      ? customerOther.value.trim()
      : customerSelect.value;
  }


  /* ===== USERS ===== */
  window._ucb = function (d) {
    if (!d.users) {
      alert("Invalid CPCC user payload");
      return;
    }

    _cl = {};
    customerSelect.innerHTML = `<option value="">Select Customer</option>`;

    d.users.forEach(u => {
      _cl[u.name] = Number(u.limit) || 0;
      customerSelect.innerHTML += `<option value="${u.name}">${u.name}</option>`;
    });

    customerSelect.innerHTML += `<option value="Others">Others</option>`;
  };

  function fetchCPCCUsers(){
    const s = document.createElement("script");
    s.src =
      "https://script.google.com/macros/s/AKfycbyvRXjrMnOmhVG06q60b0SjNbhahSgk8T1wvzeYg2QFb6JZ0XNqQyJGxMzzyk4BOcLtUg/exec" +
      "?apiKey=" + encodeURIComponent(API_KEY) +
      "&callback=_ucb";
    document.head.appendChild(s);
  }

  function fetchMenu() {
    // your original fetchMenu body here
    // leave it as is, or define a minimal dummy if not needed yet
  }

  /* ===== EXPORT FOR PIN FLOW ===== */
  window.fetchCPCCUsers = fetchCPCCUsers;
  window.fetchMenu      = fetchMenu;

  /* ===== RENDER ===== */
  function _r(){
    orderList.innerHTML = "";
    let t = 0;

    for (let n in _c) {
      const i = _c[n];
      t += i.qty * i.price;

      orderList.innerHTML += `
        <div class="order-item">
          <span class="item-name">${n} ‚Ç±${i.price}</span>
          <span class="qty-controls">
            <button class="qty-btn" onclick="changeQty('${n}',-1)">-</button>
            <span class="qty-number">${i.qty}</span>
            <button class="qty-btn" onclick="changeQty('${n}',1)">+</button>
          </span>
          <button class="del-btn" onclick="deleteItem('${n}')">X</button>
        </div>`;
    }

    if (!Object.keys(_c).length) {
      total.innerHTML = "";
      return;
    }

    const g = t;
    const v = g - g / 1.12;
    const n = g / 1.12;

    const k = _cn();
    const l = _cl[k] ?? Infinity;
    const u = _u ?? 0;

    const r = Math.max(0, l - u);
    const e = Math.max(0, n - r);
    const d = e * 0.20;
    const cs = e - d;

    if (e > 0) {
      excessReceipt.style.display = "block";
      attachReceiptHandler();
    } else {
      excessReceipt.style.display = "none";
      receiptNumber.value = "";
    }

    total.innerHTML = `
      Gross Total (VAT inclusive): ‚Ç±${g.toFixed(2)}<br>
      Less VAT (12%): ‚Ç±${v.toFixed(2)}<br>
      Total Amount (Net): ‚Ç±${n.toFixed(2)}<hr>
      CPCC Used This Month: ‚Ç±${u.toFixed(2)}
      <button onclick="_uc()" style="font-size:12px;margin-left:6px">UPDATE</button><br>
      Remaining CPCC: ‚Ç±${r.toFixed(2)}<hr>
      Excess: ‚Ç±${e.toFixed(2)}<br>
      Discount (20%): ‚Ç±${d.toFixed(2)}<br>
      <b>To be Paid in Cash: ‚Ç±${cs.toFixed(2)}</b><hr>
    `;
  }

  window._r = _r;   // üîë expose renderer globally


  /* ===== CART ===== */
  window.addItem = function(i){
    _c[i.name] ??= { qty: 0, price: i.price };
    _c[i.name].qty++;
    _r();
  };

  window.changeQty = function(n,d){
    _c[n].qty += d;
    if (_c[n].qty <= 0) delete _c[n];
    _r();
  };

  window.deleteItem = function(n){
    delete _c[n];
    _r();
  };

  /* ===== CUSTOMER ===== */
  window.handleCustomer = function(){
    _u = null;
    customerOther.style.display =
      customerSelect.value === "Others" ? "inline" : "none";
    _r();
  };

  window.cancelOrder = function(){
    if (confirm("Cancel transaction?")) {
      _c = {};
      _u = null;
      _rf();
      _r();
    }
  };

  function _rf(){
    customerSelect.value = "";
    customerOther.value = "";
    customerOther.style.display = "none";
    cpcc.value = "";
    date.value = "";
    remarks.value = "";
    excessReceipt.style.display = "none";
    receiptNumber.value = "";
  }


  /* ===== GOOGLE SHEET PUSH ===== */
  async function pushToGoogleSheet() {
    try {
      const items = _c;

      if (!Object.keys(items).length) {
        throw new Error("No items to push");
      }

      const customer = _cn();
      const limit = _cl[customer] ?? Infinity;
      let remainingCPCC = Math.max(0, limit - (_u ?? 0));

      let rows = [];

      for (let name in items) {
        const it = items[name];
        const lineTotal = it.qty * it.price;

        const netLineTotal = lineTotal / 1.12;       // VAT-excluded
        const cpccPart = Math.min(netLineTotal, remainingCPCC);
        const netExcess = Math.max(0, netLineTotal - cpccPart);

        const discount = netExcess * 0.20;
        const cashPart = netExcess * 0.80;

        remainingCPCC -= cpccPart;

       const vatAmount = lineTotal - netLineTotal;

        rows.push([
          date.value,                     // A Date
          OUTLET_NAME,                   // B Outlet
          cpcc.value,                    // C CPCC Ref
          customer,                      // D Customer
          name,                          // E Item
          it.qty,                        // F Qty
          it.price,                     // G Unit Price
          lineTotal,                    // H Gross
          vatAmount,                    // I VAT
          netLineTotal,                 // J Net
          new Date().toLocaleString(),  // K Timestamp
          "",                            // L
          cpccPart,                     // M CPCC Part
          cashPart,                     // N Cash Part
          discount,                     // O Discount
          "",                            // P
          receiptNumber.value || "",    // Q Receipt #
          remarks.value || ""           // R Remarks
        ]);
      }

      const url =
        "https://script.google.com/macros/s/AKfycbzqT5VRNzKoSH76gbQUOyRuqBPpHBEYLlAtkJPF6lgmLLpAy3ELxADSUT067reuMje66A/exec" +
        "?apiKey=" + encodeURIComponent(API_KEY) +
        "&data=" + encodeURIComponent(JSON.stringify(rows));
  
      const res = await fetch(url);
      const text = await res.text();
      console.log("GOOGLE RESPONSE:", text);
 
      if (!res.ok) {
        throw new Error(text);
      }

    } catch (e) {
      console.error("PUSH ERROR:", e);
      throw e;
    }
  }


  /* ===== CONFIRM ===== */
  window.confirmOrder = async function(){
    if (!window.API_KEY) {
      alert("Terminal not validated yet");
      return;
    }


    if (!Object.keys(_c).length) {
      alert("No items in order.");
      return;
    }

    const k = _cn();
    if (!k || !cpcc.value.trim() || !date.value) {
      alert("Customer, CPCC Ref #, and Date are required.");
      return;
    }

    if (!_f) {
      alert("CPCC not yet updated.\nSystem will sync now.");
      await new Promise(resolve => {
        const old = _f;
        window._uc();
        const i = setInterval(() => {
          if (_f !== old) {
            clearInterval(i);
            resolve();
          }
        }, 100);
      });
      return;
    }


    // üîπ If there's excess, require receipt number
    const totalNet = Object.values(_c).reduce((sum, i) => sum + (i.qty * i.price) / 1.12, 0);
    const limit = _cl[k] ?? Infinity;
    const used = _u ?? 0;
    const remaining = Math.max(0, limit - used);
    const excess = Math.max(0, totalNet - remaining);

    if (excess > 0) {
      excessReceipt.style.display = "block";
      const receipt = receiptNumber.value.trim();
      if (!receipt) {
        alert("Please enter the receipt number for the cash payment.");
        return;
      }
    }

    // üîπ Confirm popup before pushing
    if (!confirm("Confirm this transaction?")) return;
  
    // üîπ Push to Google Sheet
    try {
      await pushToGoogleSheet();
      alert("Transaction saved successfully!");
    } catch (e) {
      alert("Transaction failed to upload.\nPlease retry.");
      return;
    }


    _c = {};
    _u = null;
    _f = false;
    _rf();
    _r();
  };

})();
</script>



<script>
window._uc = async function () {
  const cust =
    customerSelect.value === "Others"
      ? customerOther.value.trim()
      : customerSelect.value;

  if (!cust || !date.value) {
    alert("Select customer & date");
    return;
  }

  total.innerHTML = "Updating CPCC...";

  let res, text;
  try {
    res = await fetch(
      HISTORY_URL + "?apiKey=" + encodeURIComponent(API_KEY),
      { cache: "no-store" }
    );
  } catch {
    alert("Failed to reach CPCC server.");
    return;
  }

  if (!res.ok) {
    alert("CPCC server error: " + res.status);
    return;
  }

  try {
    text = await res.text();
  } catch {
    alert("Failed to read CPCC response.");
    return;
  }

  let data;
  try {
    data = JSON.parse(text);
  } catch {
    const m = text.match(/\{[\s\S]*\}/);
    if (!m) {
      alert("Invalid CPCC server response.");
      return;
    }
    data = JSON.parse(m[0]);
  }

  const rows = Array.isArray(data) ? data : [];

  // üîê normalize selected month
  const sd = new Date(date.value);
  const selMonth =
    sd.getFullYear() + "-" + (sd.getMonth() + 1);

  let used = 0;

  rows.forEach(r => {
    if (!r.customer || !r.date) return;

    // üßº normalize customer strings
    const rowCustomer = String(r.customer).trim();
    const selCustomer = cust.trim();

    if (rowCustomer !== selCustomer) return;

    // üóì normalize row month
    const rd = new Date(r.date);
    const rowMonth =
      rd.getFullYear() + "-" + (rd.getMonth() + 1);

    if (rowMonth !== selMonth) return;

    // üí∞ backend-aligned CPCC usage
    used += Number(r.cpccPart || r.lineTotal || 0);
  });

  // üîÅ sync to app state
  window._u = used;   // CPCC used this month
  window._f = true;   // CPCC fresh

  // üîÑ refresh UI
  if (typeof _r === "function") {
    _r();
  }
};

</script>




<script>
(function(){

  /* ===== HISTORY ===== */
  const _ho = window.OUTLET_NAME; // friendly outlet name for history
  const _hu = "https://script.google.com/macros/s/AKfycbzqT5VRNzKoSH76gbQUOyRuqBPpHBEYLlAtkJPF6lgmLLpAy3ELxADSUT067reuMje66A/exec";

  window.openHistory = function(){
    document.body.classList.add("history-open");
  };

  window.closeHistory = function(){
    document.body.classList.remove("history-open");
  };

  window.fetchHistory = async function(){
    const from = historyFrom.value;
    const to   = historyTo.value;

    if (!from || !to) {
      alert("Please select From and To dates");
      return;
    }

    historyBody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

    try {
      const res  = await fetch(_hu + "?apiKey=" + encodeURIComponent(API_KEY));
      const data = await res.json();

      const grouped = {};
      historyBody.innerHTML = "";

      data.forEach(r => {
        const rowDate   = r.date;
        const rowOutlet = r.outlet;

        if (rowOutlet !== _ho || rowDate < from || rowDate > to) return;

        const ref = String(r.cpcc || "").trim();
        if (!ref) return;

        if (!grouped[ref]) {
          grouped[ref] = {
            date: rowDate,
            cpcc: ref,
            customer: r.customer,
            gross: 0,
            cpccAmt: 0,
            cash: 0,
            receipt: r.excessReceipt || "",
            remarks: r.remarks || ""
          };
        } else if (rowDate < grouped[ref].date) {
          grouped[ref].date = rowDate;
        }

        grouped[ref].gross   += Number(r.lineTotal) || 0;
        grouped[ref].cpccAmt += Number(r.cpccPart)  || 0;
        grouped[ref].cash    += Number(r.cashPart)  || 0;

        if (r.excessReceipt) grouped[ref].receipt = r.excessReceipt;
        if (r.remarks)       grouped[ref].remarks = r.remarks;
      });

      Object.values(grouped).forEach(row => {
        const d = new Date(row.date);
        const fd = String(d.getMonth()+1).padStart(2,"0") + "/" +
                   String(d.getDate()).padStart(2,"0") + "/" +
                   String(d.getFullYear()).slice(-2);

        historyBody.innerHTML += `
          <tr>
            <td>${fd}</td>
            <td>${row.cpcc}</td>
            <td>${row.customer}</td>
            <td>‚Ç±${row.gross.toFixed(2)}</td>
            <td>‚Ç±${row.cpccAmt.toFixed(2)}</td>
            <td>‚Ç±${row.cash.toFixed(2)}</td>
            <td>${row.receipt}</td>
            <td>${row.remarks}</td>
          </tr>
        `;
      });

      if (!Object.keys(grouped).length) {
        historyBody.innerHTML = "<tr><td colspan='8'>No records found</td></tr>";
      }

    } catch(e) {
      console.error(e);
      alert("Failed to fetch history");
    }
  };

})();
</script>










<script>
(function () {

  /* ===== MENU DATA ===== */
  let _m = {};     // MENU
  let _ml = false;
  let _ai = null;

  /* ===== MENU CALLBACK ===== */
  window._mcb = function (d) {
    try {
      if (!Array.isArray(d)) throw "BAD_MENU";

      _m = {};

      d.forEach(i => {
        const c = i.category;
        const n = i.name;
        const p = Number(i.price);

        if (!c || !n || isNaN(p)) return;
        (_m[c] ??= []).push({ name: n, price: p });
      });

      for (let c in _m) {
        _m[c].sort((a, b) => a.name.localeCompare(b.name));
      }

      _ml = true;
      _rc();

    } catch (e) {
      console.error("MENU LOAD ERROR", e);
      alert("Failed to load Menu List");
    }
  };

  /* ===== FETCH MENU (EXPORTED) ===== */
  function fetchMenu() {
    const s = document.createElement("script");
    s.src =
      "https://script.google.com/macros/s/AKfycbyQVcIMP8HPkPVl_T3HhkISz_BRSBOo98kKTAydZ_fBCHiM1OaVwp9b0FqMNa9YLGserQ/exec" +
      "?apiKey=" + encodeURIComponent(API_KEY) +
      "&callback=_mcb";

    s.onerror = () => alert("Menu server unreachable");
    document.head.appendChild(s);
  }

  window.fetchMenu = fetchMenu;

  /* ===== RENDER CATEGORIES ===== */
  function _rc() {
    categories.style.display = "grid";
    menuGrid.style.display = "none";
    backBtn.style.display = "none";

    categories.innerHTML = "";

    Object.keys(_m).forEach(c => {
      categories.innerHTML +=
        `<button class="cat-btn" onclick="showCategory('${c}')">${c}</button>`;
    });

    categories.innerHTML +=
      `<button class="cat-btn" onclick="showManualInput()">Manual Input</button>`;
  }

  /* ===== SHOW CATEGORY ===== */
  window.showCategory = function (c) {
    categories.style.display = "none";
    menuGrid.style.display = "grid";
    backBtn.style.display = "block";

    menuGrid.innerHTML = "";
    _m[c].forEach(i => {
      menuGrid.innerHTML +=
        `<button class="menu-btn" onclick='addItem(${JSON.stringify(i)})'>
          ${i.name} ‚Ç±${i.price}
        </button>`;
    });
  };

  /* ===== MANUAL INPUT ===== */
  window.showManualInput = function () {
    categories.style.display = "none";
    menuGrid.style.display = "flex";
    backBtn.style.display = "block";

    menuGrid.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px;padding:10px;">
        <input id="manualName" placeholder="Menu Name">
        <input id="manualPrice" placeholder="Price" type="number" min="0">
        <button onclick="addManualItem()">Add to Order</button>
      </div>`;
  };

  window.addManualItem = function () {
    const n = document.getElementById("manualName").value.trim();
    const p = parseFloat(document.getElementById("manualPrice").value);

    if (!n || isNaN(p)) {
      alert("Enter valid Name and Price");
      return;
    }

    addItem({ name: n, price: p });
    menuGrid.innerHTML = "";
    showCategories();
  };

  window.showCategories = function () {
    _rc();
  };

  /* ===== RECEIPT NUMPAD HANDLER ===== */
  window.attachReceiptHandler = function () {
    const r = document.getElementById("receiptNumber");
    if (!r) return;

    r.onclick = e => {
      e.stopPropagation();
      _ai = r;
      numpad.style.display = "block";
      keyboard.style.display = "none";
    };
  };

  function safeShow(el) { if (el) el.style.display = "block"; }
  function safeHide(el) { if (el) el.style.display = "none"; }

  document.addEventListener("DOMContentLoaded", () => {
    cpcc.onclick = () => { _ai = cpcc; safeShow(numpad); safeHide(keyboard); };
    remarks.onclick = () => { _ai = remarks; safeShow(keyboard); safeHide(numpad); };
  });


  /* ===== PAD CONTROLS ===== */
  window.padInput = v => { if (_ai) _ai.value += v; };
  window.padBack  = () => { if (_ai) _ai.value = _ai.value.slice(0, -1); };
  window.closePad = () => {
    if (numpad)   numpad.style.display = "none";
    if (keyboard) keyboard.style.display = "none";
    _ai = null;
  };

  document.addEventListener("click", e => {
    if (!numpad || !keyboard) return;

    if (
      !e.target.closest(".pad") &&
      e.target !== cpcc &&
      e.target !== remarks
    ) {
      closePad();
    }
  });

  cpcc.addEventListener("input", () => {
    cpcc.value = cpcc.value.replace(/\D/g, "");
  });

})();
</script>

<!-- NUMPAD -->
<div id="numpad" class="pad">
  <div class="pad-header">CPCC <button onclick="closePad()">‚úï</button></div>
  <div class="pad-grid">
    <button onclick="padInput('1')">1</button><button onclick="padInput('2')">2</button><button onclick="padInput('3')">3</button>
    <button onclick="padInput('4')">4</button><button onclick="padInput('5')">5</button><button onclick="padInput('6')">6</button>
    <button onclick="padInput('7')">7</button><button onclick="padInput('8')">8</button><button onclick="padInput('9')">9</button>
    <button onclick="padBack()">‚å´</button><button onclick="padInput('0')">0</button><button onclick="closePad()">OK</button>
  </div>
</div>

<!-- KEYBOARD -->
<div id="keyboard" class="pad">
  <div class="pad-header">Remarks <button onclick="closePad()">‚úï</button></div>

<div class="kbd-grid">
  <button onclick="padInput('1')">1</button><button onclick="padInput('2')">2</button><button onclick="padInput('3')">3</button><button onclick="padInput('4')">4</button><button onclick="padInput('5')">5</button>
  <button onclick="padInput('6')">6</button><button onclick="padInput('7')">7</button><button onclick="padInput('8')">8</button><button onclick="padInput('9')">9</button><button onclick="padInput('0')">0</button>

  <button onclick="padInput('Q')">Q</button><button onclick="padInput('W')">W</button><button onclick="padInput('E')">E</button><button onclick="padInput('R')">R</button><button onclick="padInput('T')">T</button>
  <button onclick="padInput('Y')">Y</button><button onclick="padInput('U')">U</button><button onclick="padInput('I')">I</button><button onclick="padInput('O')">O</button><button onclick="padInput('P')">P</button>

  <button onclick="padInput('A')">A</button><button onclick="padInput('S')">S</button><button onclick="padInput('D')">D</button><button onclick="padInput('F')">F</button><button onclick="padInput('G')">G</button>
  <button onclick="padInput('H')">H</button><button onclick="padInput('J')">J</button><button onclick="padInput('K')">K</button><button onclick="padInput('L')">L</button>

  <button onclick="padInput('Z')">Z</button><button onclick="padInput('X')">X</button><button onclick="padInput('C')">C</button><button onclick="padInput('V')">V</button><button onclick="padInput('B')">B</button>
  <button onclick="padInput('N')">N</button><button onclick="padInput('M')">M</button>

  <button onclick="padBack()">‚å´</button>
  <button onclick="padInput(' ')">SPACE</button>
  <button onclick="closePad()">OK</button>
</div>




<script>
(function () {
  window._d = {
    cs: document.getElementById("customerSelect"),
    co: document.getElementById("customerOther"),
    cp: document.getElementById("cpcc"),
    dt: document.getElementById("date"),
    rm: document.getElementById("remarks"),
    ol: document.getElementById("orderList"),
    tt: document.getElementById("total"),
    cg: document.getElementById("categories"),
    mg: document.getElementById("menuGrid"),
    bb: document.getElementById("backBtn"),
    er: document.getElementById("excessReceipt"),
    rn: document.getElementById("receiptNumber"),
    hb: document.getElementById("historyBody"),
    np: document.getElementById("numpad"),
    kb: document.getElementById("keyboard")
  };

  /* expose expected globals (compat layer) */
  customerSelect = _d.cs;
  customerOther  = _d.co;
  cpcc           = _d.cp;
  date           = _d.dt;
  remarks        = _d.rm;
  orderList      = _d.ol;
  total          = _d.tt;
  categories     = _d.cg;
  menuGrid       = _d.mg;
  backBtn        = _d.bb;
  excessReceipt  = _d.er;
  receiptNumber  = _d.rn;
  historyBody    = _d.hb;
  numpad         = _d.np;
  keyboard       = _d.kb;

})();
</script>

<script>
(function () {

  document.addEventListener("contextmenu", e => e.preventDefault());

  document.addEventListener("keydown", e => {
    const k = e.key;
    if (
      k === "F12" ||
      (e.ctrlKey && e.shiftKey && (k === "I" || k === "J" || k === "C")) ||
      (e.ctrlKey && k === "U")
    ) {
      e.preventDefault();
    }
  });

  document.addEventListener("touchstart", function () {}, { passive: false });

})();
</script>



</body>
</html>
